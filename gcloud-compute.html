<!--
  This file contains a collection of product specific
  components for interacting with Google Compute Engine,
  organized under the gcloud-compute namespace.
-->

<!--
gcloud-compute-base is a base element containing common
data and behavior to be inherited by other components 
within this collection. This element is intended for
internal use within this component collection - it should 
not be directly specified by developers.
-->

<polymer-element name="gcloud-compute-base" attributes="scope">

  <link rel="stylesheet" href="google-gcloud.css">

  <template>
    <style>
      .iblock { display: inline-block; }
    </style>
    <span class="iblock" style="border:7px solid {{border_color}};">
      <span class="iblock" style="border:3px solid white">
        <content></content>
      </span>
    </span>
  </template>

  <script>
    var API_VERSION = 'v1';

    Polymer({

     /**
       * The `author` attribute sets an initial author
       * 
       * @attribute author
       * @type string
       */
      author: 'Marc Cohen',

      border_color: 'red',

      base_url: 'https://www.googleapis.com/compute/' + 
                API_VERSION + '/projects/',

      /**
       * 'scope' is the Compute Engine scope associated 
       * with a given resource. In practical terms, if will
       * be a string taken from the following set of values:
       * 'global', 'regional', 'zonal'
       *
       * @attribute scope
       * @type string
       */
      scope: 'global',
      
      ready: function() {
        this.gapi = document.querySelector('gcloud-gapi');
        this.config = document.querySelector('gcloud-config');
      },

      get_wait_func: function() {
        var wait_func = null;
        if (this.scope == 'global') {
          wait_func = gapi.client.compute.globalOperations;
        } else if (this.scope == 'regional') {
          wait_func = gapi.client.compute.regionOperations;
        } else if (this.scope == 'zonal') {
          wait_func = gapi.client.compute.zoneOperations;
        }
        return wait_func;
      },

      wait: function(result) {
        console.log(result);
        var get_req = {
          operation: result.name,
          project: this.config.project,
        }
        if (this.scope == 'zonal') {
          get_req['zone'] = this.zone;
        }
        this.get_wait_func().get(get_req).execute(function(result) {
          if (result.status != "DONE") {
            this.async(this.wait, result, 1000);
          } else {
            this.fire('done', this.name);
          }
        }.bind(this))
      }
    });
  </script>
</polymer-element>

<!--
gcloud-compute-image creates a private Compute Engine image
in the project configured by a gcloud-config element.

##### Example

  <gcloud-gapi ...></gcloud-gapi>
  <gcloud-config ...></gcloud-config>
  <gcloud-compute-image id="my-image" 
    src="gs://my-bucket/my-object.tar.gz">
  </gcloud-compute-image>

@element gcloud-compute-image
@blurb gcloud-compute-image creates a Google Compute Engine image from a Google Cloud Storage object.
@status alpha
@url https://github.com/GoogleWebComponents/google-gcloud
-->

<polymer-element name="gcloud-compute-image" 
  attributes="name src"
  extends="gcloud-compute-base">

  <script>
    Polymer({
      /**
       * 'name' is the name to assign the image.
       * @attribute name
       * @type string
       */
      name: '',

      /**
       * 'src' points to the Cloud Storage object to use
       * as input for creating the image.
       *
       * @attribute src
       * @type string
       */
      src: '',

      /**
       * The 'go' method creates the Google Cloud Engine image.
       * @method go
       * @return {Object} Returns undefined.
       */
      go: function() {
        this.gapi.auth(function(result) {
          var payload = {
            project: this.config.project,
            resource: {
              name: this.name,
              sourceType: 'RAW',
              rawDisk: {
                source: this.src
              }
            }
          };
          gapi.client.compute.images.insert(payload).execute(this.wait.bind(this));
        }.bind(this));
      }
    });
  </script>
</polymer-element>

<!--
gcloud-compute-disk creates a Google Compute Engine disk.
Suitable defaults are chosen for all attributes so that,
in the simplest use case, you can create a disk without 
specifying any attributes.

##### Example

  <gcloud-gapi ...></gcloud-gapi>
  <gcloud-config ...></gcloud-config>
  <gcloud-compute-disk id="my-disk"></gcloud-compute-disk>

@element gcloud-compute-disk
@blurb gcloud-compute-disk creates a Google Compute Engine disk
@status alpha
@url https://github.com/GoogleWebComponents/google-gcloud
-->

<polymer-element name="gcloud-compute-disk" 
  attributes="name zone size image" 
  extends="gcloud-compute-base">

  <script>
    Polymer({
      // Force zonal scope in base element.
      scope: 'zonal',

      /**
       * 'name' is the name to assign to the new disk.
       * @attribute name
       * @type string
       */
      name: 'my-disk',

      /**
       * 'zone' is the desired location for the new disk.
       * @attribute zone
       * @type string
       */
      zone: 'us-central1-a',

      /**
       * 'size' is the capacity (in GB) for the new disk.
       * @attribute size
       * @type integer 
       */
      size: 10,

      /**
       * 'image' is the image to use for the new disk.
       * It may contain a ':', in which case the image
       * string is assumed to contain a project and
       * and image name with that project, e.g.,
       *
       *   debian-cloud:debian-7-wheezy-v20140606
       *
       * It's also acceptable to specify a null project
       * with or without the colon, which assumes the
       * desired image is to be taken from the project
       * configured by the <gcloud-config> element.
       *
       * @attribute image
       * @type string
       */
      image: 'debian-cloud:debian-7-wheezy-v20140606',

      /**
       * The 'go' method creates the Compute Engine disk.
       * @method go
       * @return {Object} Returns undefined.
       */
      go: function() {
        this.gapi.auth(function(result) {
          var li = this.image.split(':');
          var image_project = '';
          var image_name = '';
          if (li.length == 2) {
            image_project = li[0]; 
            image_name = li[1]; 
          } else if (li.length == 1) {
            image_project = this.config.project; 
            image_name = li[0]; 
          } else {
            image_project = this.config.project; 
            image_name = 'default'; 
          }
          var payload = {
            project: this.config.project,
            zone: this.zone,
            resource: {
              name: this.name,
              sizeGb: this.size,
              sourceImage: this.base_url + image_project + 
                           '/global/images/' + image_name
            }
          };
          gapi.client.compute.disks.insert(payload).execute(this.wait.bind(this));
        }.bind(this));
      }
    });
  </script>
</polymer-element>

<!--
gcloud-compute-instance creates a Compute Engine virtual 
machine. Suitable defaults are chosen for all attributes 
so that, in the simplest use case, you can create a disk 
without specifying any attributes.

##### Example

    <gcloud-gapi ...></gcloud-gapi>
    <gcloud-config ...></gcloud-config>
    <gcloud-compute-instance id="my-vm">my-vm
    </gcloud-compute-disk>

@element gcloud-compute-instance
@blurb gcloud-compute-instance creates a Compute Engine VM 
@status alpha
@url https://github.com/GoogleWebComponents/google-gcloud
-->

<polymer-element name="gcloud-compute-instance" 
  attributes="name zone net_name disk_name disk_type disk_boot disk_autodel disk_size disk_image"
  extends="gcloud-compute-base">

  <script>
    Polymer({
      // Element state must be one of:
      // 'init', 'starting', 'started', 'stopping'
      state: 'init',

      // Force zonal scope in base element.
      scope: 'zonal',

      /**
       * 'name' is the name of the new virtual machine.
       * @attribute name
       * @type string
       */
      name: 'my-vm',

      /**
       * 'zone' is the desired zone for the new VM.
       * @attribute zone
       * @type string
       */
      zone: 'us-central1-a',

      /**
       * 'type' is the desired machine type.
       * @attribute type
       * @type string
       */
      type: 'f1-micro',

      /**
       * 'net_name' is the desired network name.
       * @attribute net_name
       * @type string
       */
      net_name: 'default',

      /**
       * 'disk_name' is the name to assign to the boot disk.
       * @attribute disk_name
       * @type string
       */
      disk_name: '',

      /**
       * 'disk_type' is the desired type of the boot disk.
       * @attribute disk_type
       * @type string
       */
      disk_type: 'PERSISTENT',

      /**
       * 'disk_boot' is a boolean indicating whether the 
       * disk should be bootable or not.
       *
       * @attribute disk_boot
       * @type string
       */
      disk_boot: true,

      /**
       * 'disk_autodel' indicates whether to automatically
       * delete the boot disk whenever the VM is deleted.
       *
       * @attribute disk_autodel
       * @type string
       */
      disk_autodel: true,

      /**
       * 'disk_size' is the desired disk capacity (in GB).
       * @attribute disk_size
       * @type string
       */
      disk_size: '10',

      /**
       * 'disk_image' is the image to use for the boot disk.
       * It may contain a ':', in which case the image
       * string is assumed to contain a project and
       * and image name with that project, e.g.,
       *
       *   debian-cloud:debian-7-wheezy-v20140606
       *
       * It's also acceptable to specify a null project
       * with or without the colon, which assumes the
       * desired image is to be taken from the project
       * configured by the <gcloud-config> element.
       *
       * @attribute disk_image
       * @type string
       */
      disk_image: 'debian-cloud:debian-7-wheezy-v20140606',

      /**
       * The 'gen_instance_payload' method generates a
       * json payload for inserting an instance.
       *
       * @method gen_instance_payload
       * @return {Object} Returns a JSON object.
       */
      gen_instance_payload: function() {
        var li = this.disk_image.split(':');
        var image_project = '';
        var image_name = '';
        if (li.length == 2) {
          image_project = li[0]; 
          image_name = li[1]; 
        } else if (li.length == 1) {
          image_project = this.config.project; 
          image_name = li[0]; 
        } else {
          image_project = this.config.project; 
          image_name = 'default'; 
        }
        if (!this.disk_name) {
          this.disk_name = this.name;
        }
        var payload = {
          project: this.config.project,
          name: this.name,
          zone: this.zone,
          resource: {
            name: this.name,
            machineType: this.base_url + 
              this.config.project + '/zones/' + this.zone + 
              '/machineTypes/' + this.type,
            networkInterfaces: [{ 
              network: this.base_url + this.config.project +
                       '/global/networks/' + this.net_name,
              accessConfigs: [{type: 'ONE_TO_ONE_NAT'}]
            }],
            disks: [{
              type: this.disk_type,
              boot: this.disk_boot,
              autoDelete: this.disk_autodel,
              initializeParams: {
                diskName: this.disk_name,
                diskSizeGb: this.disk_size,
                sourceImage: this.base_url + image_project + 
                             '/global/images/' + image_name
              }
            }] 
          }
        };
        return payload;
      },

      /**
       * The 'progress' method displays or removes a 
       * progress indicator and updates the border color
       * for the contained content, as a function of the
       * current state.
       *
       * @method progress
       * @return {Object} Returns undefined.
       */
      progress: function() {
        if (this.state == 'init' || this.state == 'started') {
          // Remove progress indicator.
          var prog = 
            document.querySelector('#prog-' + this.name);
          this.parentNode.removeChild(prog);
          if (this.state == 'init') {
            this.border_color = 'red';
          } else {
            this.border_color = 'green';
          }
        } else {
          // Insert progress indicator.
          var prog = document.createElement('progress');
          prog.id = 'prog-' + this.name;
          this.parentNode.appendChild(prog);
          this.border_color = 'gray';
        }
      },

      /**
       * The 'go' method creates the Compute Engine VM.
       * @method go
       * @return {Object} Returns undefined.
       */
      go: function() {
        this.gapi.auth(function(result) {
          this.addEventListener('done', function(e) {
            if (this.state == 'starting') {
              this.state = 'started';
            } else if (this.state == 'stopping') {
              this.state = 'init';
            } 
            this.progress();
          });
          if (this.state == 'started') {
            this.state = 'stopping';
            this.progress();

            var payload = {
              project: this.config.project,
              instance: this.name,
              zone: this.zone,
            };
            gapi.client.compute.instances.delete(payload).execute(this.wait.bind(this));
          } else  if (this.state == 'init') {
            this.state = 'starting';
            this.progress();
            var payload = this.gen_instance_payload();
            gapi.client.compute.instances.insert(payload).execute(this.wait.bind(this));
          }
        }.bind(this));
      },
    });
  </script>
</polymer-element>
