<!--
  This file contains a collection of product specific
  components for interacting with Google Compute Engine,
  organized under the gcloud-compute namespace.
-->

<!--
gcloud-compute-base is a base element containing common
data and behavior to be inherited by other components 
within this collection. This element is intended for
internal use within this component collection - it should 
not be directly specified by developers.
-->

<polymer-element name="gcloud-compute-base" 
  attributes="scope"> 

  <script>
    Polymer({
      api_version: 'v1',
      base_url: 'https://www.googleapis.com/compute/' + 
                this.api_version + '/projects/',

      /**
       * 'scope' is the Compute Engine scope associated 
       * with a given resource. In practical terms, if will
       * be a string taken from the following set of values:
       * 'global', 'regional', 'zonal'
       *
       * @attribute scope
       * @type string
       */
      scope: 'global',
      
      ready: function() {
        this.gapi = document.querySelector('google-gapi');
        this.config = document.querySelector('gcloud-config');
        if (scope == 'global') {
          this.wait_func = 
            gapi.client.compute.globalOperations;
        } else if (scope == 'regional') {
          this.wait_func = 
            gapi.client.compute.regionOperations;
        } else if (scope == 'zonal') {
          this.wait_func = gapi.client.compute.zoneOperations;
        }
      },

      wait: function(result) {
        console.log(result);
        var get_req = {
          operation: result.name,
          project: this.config.project,
        }
        if (scope == 'zonal') {
          get_req['zone'] = this.zone;
        }
        this.wait_func.get(get_req).execute(function(result) {
          if (result.status != "DONE") {
            this.async(this.wait, result, 1000);
          } else {
            this.fire('done', result);
          }
        }.bind(this));
       }

</polymer-element>

<!--
gcloud-compute-disk creates a Google Compute Engine disk.
Suitable defaults are chosen for all attributes so that,
in the simplest use case, you can create a disk without 
specifying any attributes.

##### Example

  <google-gapi ...></google-gapi>
  <gcloud-config ...></gcloud-config>
  <gcloud-compute-disk id="my-disk"></gcloud-compute-disk>
  <script>
    document.querySelector('#my-disk').go(function(result) {
      console.log(result);
    });
  </script>

@element gcloud-compute-disk
@blurb gcloud-compute-disk creates a Google Compute Engine disk
@status alpha
@url https://github.com/GoogleWebComponents/google-gcloud
-->

<polymer-element name="gcloud-compute-disk" 
  attributes="name zone size image" 
  extends="gcloud-compute-base">

  <script>
    Polymer({
      /**
       * 'name' is the name to assign to the new disk.
       * @attribute name
       * @type string
       */
      name: 'my-disk',

      /**
       * 'zone' is the desired location for the new disk.
       * @attribute zone
       * @type string
       */
      zone: 'us-central1-a',

      /**
       * 'size' is the capacity (in GB) for the new disk.
       * @attribute size
       * @type integer 
       */
      size: 10,

      /**
       * 'image' is the image to use for the new disk.
       * It may contain a ':', in which case the image
       * string is assumed to contain a project and
       * and image name with that project, e.g.,
       *
       *   debian-cloud:debian-7-wheezy-v20140606
       *
       * It's also acceptable to specify a null project
       * with or without the colon, which assumes the
       * desired image is to be taken from the project
       * configured by the <gcloud-config> element.
       *
       * @attribute image
       * @type string
       */
      image: 'debian-cloud:debian-7-wheezy-v20140606',

      /**
       * The 'go' method creates the Compute Engine disk.
       * @method go
       * @return {Object} Returns undefined.
       */
      go: function() {
        this.gapi.auth(function(result) {
          var li = this.image.split(':');
          var image_project = '';
          var image_name = '';
          if (li.length == 2) {
            image_project = li[0]; 
            image_name = li[1]; 
          } else if (li.length == 1) {
            image_project = this.config.project; 
            image_name = li[0]; 
          } else {
            image_project = this.config.project; 
            image_name = 'default'; 
          }
          var payload = {
            project: this.config.project,
            zone: this.zone,
            resource: {
              name: this.name,
              sizeGb: this.size,
              sourceImage: this.base_url + image_project + 
                           '/global/images/' + image_name;
            }
          };
          gapi.client.compute.disks.insert(payload).execute(this.wait.bind(this));
        }.bind(this));
      }
    });
  </script>
</polymer-element>

<!--
gcloud-compute-image creates a Google Compute Engine image.

##### Example

    <google-gapi ...></google-gapi>
    <gcloud-config ...></gcloud-config>
    <gcloud-compute-image id="my-image" src="gs://my-bucket/my-filesystem.tar.gz"></gcloud-compute-image>
    <script>
      document.querySelector('#my-image').go(function(result) {
        console.log(result);
      });
    </script>

@element gcloud-compute-image
@blurb gcloud-compute-image creates a Google Compute Engine image from a filesystem tarball on Google Cloud Storage.
@status alpha
@url https://github.com/proppy/gce-elements
-->

<polymer-element name="gcloud-compute-image" 
  attributes="name src"
  extends="gcloud-compute-base">

  <script>
    Polymer({
      /**
       * The `name` attribute is the name of the image resource.
       *
       * @attribute name
       * @type string
       */
      name: '',

      /**
       * The `src` attribute points to the image filesystem tarball on Google Cloud Storage.
       *
       * @attribute src
       * @type string
       */
      src: '',

      /**
       * The `go` method creates the Google Cloud Engine image.
       *
       * @method go
       * @return {Object} Returns undefined.
       */
      go: function() {
        this.gapi.auth(function(result) {
          var payload = {
            project: this.config.project,
            resource: {
              name: this.name,
              sourceType: 'RAW',
              rawDisk: {
                source: this.src
              }
            }
          };
          gapi.client.compute.images.insert(payload).execute(this.wait.bind(this));
        }.bind(this));
      }
    });

  </script>

</polymer-element>
<!--
gcloud-compute-instance creates a Google Compute Engine instance.

##### Example

    <google-gapi ...></google-gapi>
    <gcloud-config ...></gcloud-config>
    <gcloud-compute-instance id="instance-id" name="my-instance" zone="zone" type="type" disk_name="my_boot_disk" disk_image="my-image"></gcloud-compute-disk>
    <script>
      document.querySelector('#my-disk').go(function(result) {
        console.log(result);
      });
    </script>

@element gcloud-compute-instance
@blurb gcloud-compute-instance creates a Google Compute Engine instance
@status alpha
@url https://github.com/proppy/gce-elements
-->

<polymer-element name="gcloud-compute-instance" 
  attributes="name zone net_name disk_name disk_type disk_boot disk_autodel disk_size disk_image_project disk_image"
  extends="gcloud-compute-base">

  <script>

    Polymer({
      /**
       * The `name` attribute is the name of the disk resource.
       *
       * @attribute name
       * @type string
       */
      name: '',

      /**
       * The `zone` attribute is the name of the desired zone.
       *
       * @attribute zone
       * @type string
       */
      zone: 'us-central1-a',

      /**
       * The `type` attribute is the name of the desired machine type.
       *
       * @attribute type
       * @type string
       */
      type: 'n1-standard-1',

      /**
       * The `net_name` attribute is the name of the desired network.
       *
       * @attribute net_name
       * @type string
       */
      net_name: 'default',

      /**
       * The `disk_name` attribute is the name of the boot disk.
       *
       * @attribute disk_name
       * @type string
       */
      disk_name: '',

      /**
       * The `disk_type` attribute is the desired disk type.
       *
       * @attribute disk_type
       * @type string
       */
      disk_type: 'PERSISTENT',

      /**
       * The `disk_boot` attribute is the desired boot state.
       *
       * @attribute disk_boot
       * @type string
       */
      disk_boot: true,

      /**
       * The `disk_autodel` attribute is the desired disk auto-delete state.
       *
       * @attribute disk_autodel
       * @type string
       */
      disk_autodel: true,

      /**
       * The `disk_size` attribute is the desired disk size (in GB).
       *
       * @attribute disk_size
       * @type string
       */
      disk_size: '10',

      /**
       * The `disk_image` attribute is the desired disk image.
       *
       * @attribute disk_image
       * @type string
       */
      disk_image: '',

      /**
       * The `disk_image_project` attribute is the project for the disk image.
       *
       * @attribute disk_image_project
       * @type string
       */
      disk_image_project: '',

      /**
       * The `go` method creates the Google Compute Engine disk.
       *
       * @method go
       * @return {Object} Returns undefined.
       */
      go: function() {
        var DEFAULT_NETWORK = this.base_url + this.config.project + 
                              '/global/networks/default'
        this.gapi.auth(function(result) {
          var payload = {
            project: this.config.project,
            name: this.name,
            zone: this.zone,
            resource: {
              name: this.name,
              machineType: this.base_url + this.config.project + 
                           '/zones/' + this.zone + '/machineTypes/' + 
                           this.type,
              networkInterfaces: [{ 
                                    network: this.base_url + this.config.project +
                                             '/global/networks/' + 
                                             this.net_name,
                                    accessConfigs: [{type: 'ONE_TO_ONE_NAT'}]
                                  }],
              disks: [{
                        type: this.disk_type,
                        boot: this.disk_boot,
                        autoDelete: this.disk_autodel,
                        initializeParams: {
                                            diskName: this.disk_name,
                                            diskSizeGb: this.disk_size,
                                            sourceImage: this.base_url + 
                                                         this.disk_image_project +
                                                         '/global/images/' + 
                                                         this.disk_image
                                          }
                      }] 
            }
          };
          gapi.client.compute.instances.insert(payload).execute(this.wait.bind(this));
        }.bind(this));
      },
    });

  </script>

</polymer-element>
